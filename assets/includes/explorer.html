<body>
    <div id="vault-name">{{ site.obsidian_vault }}</div>
    <div id="file-tree"></div>
</body>

<script lang="text/javascript">
    function buildFileTree(element, tree) {
        const ul = document.createElement('ul');
        element.appendChild(ul);

        tree.forEach(child => {
            const li = document.createElement('li');
            ul.appendChild(li);

            const button = document.createElement('button');
            button.textContent = child.name;
            li.appendChild(button);

            if (child.type === 'dir') {
                li.classList.add('dir');
                const rightArrow = `
                <svg class="dynamic-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m9 5 7 7-7 7"/>
                </svg>`;

                const downArrow = `
                <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="dynamic-svg" viewBox="0 0 24 24" fill="none">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m5 9 7 7 7-7"/>
                </svg>`;


                button.innerHTML = rightArrow + button.textContent;

                var expanded = false;
                button.addEventListener('click', () => {
                    expanded = !expanded;
                    button.innerHTML = (expanded ? downArrow : rightArrow) + button.textContent;

                    if (expanded) {
                        // Check if the child nodes have already been created
                        if (!li.querySelector('ul')) {
                            buildFileTree(li, child.children);
                        }
                    } else {
                        const nestedUl = li.querySelector('ul');
                        if (nestedUl) {
                            li.removeChild(nestedUl);
                        }
                    }
                });
            } else if (child.type === 'file') {
                li.classList.add('file');
                button.addEventListener('click', () => {
                    console.log(child.path);
                    var event = new CustomEvent('obisidianFileSelect', { detail: child.path });
                    document.dispatchEvent(event);
                });
                button.textContent = child.name.replace(/\.[^/.]+$/, "");
            }
        });
    }

    var obsidianFilesJson = '{{ site.data.obsidian_files_json | escape }}';
    var parsedObsidianFilesJson = JSON.parse(obsidianFilesJson.replace(/&quot;/g, '"'));

    function sortObsidianFiles(tree) {
        tree.sort((a, b) => {
            if (a.type === 'dir' && b.type === 'file') {
                return -1;
            } else if (a.type === 'file' && b.type === 'dir') {
                return 1;
            } else {
                return a.name.localeCompare(b.name);
            }
        });
        tree.forEach(child => {
            if (child.type === 'dir') {
                sortObsidianFiles(child.children);
            }
        });
        return tree;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const rootElement = document.getElementById('file-tree');
        const sortedFiles = sortObsidianFiles(parsedObsidianFilesJson);
        buildFileTree(rootElement, sortedFiles);
    });
    console.log(parsedObsidianFilesJson);
    console.log("DIR root " + '{{ site.obsidian_vault | escape }}')
</script>

<style>
    #vault-name {
        margin-bottom: 3px;
        font-weight: 500;
        font-size: 1.1rem;
        padding-left: 14px;
    }

    .dynamic-svg {
        width: 100%;
        height: 100%;
        max-width: 16px;
        max-height: 16px;
    }

    ul button {
        padding-left: 0px;
        display: flex;
        align-items: center;

        background: none;
        border: none;
        padding: 0;
        margin: 0;
        outline: none;
        box-shadow: none;
        font: inherit;
        color: #606060;
    }

    ul {
        list-style-type: none;
        padding-left: 0px;
        margin-left: 0px;
    }

    ul ul,
    ul li.file {
        padding-left: 7px;
        padding-top: 5px;
    }

    /*First level files*/
    #file-tree>ul>li.file {
        margin-left: 14px;
    }

    /* Left border for nested child files */
    #file-tree ul ul li.file {
        border-left: 1px solid #e0e0e0;
    }

    ul li.file {
        margin-left: 0px;
    }


    ul li.file:hover,
    ul li.dir button:hover {
        background-color: #e4e4e4;
    }

    ul li,
    ul ul li {
        padding-bottom: 4px;
    }
</style>