<head>
    <style>
        #vault-name {
            margin-bottom: 3px;
            font-weight: 500;
            font-size: 1.1rem;
            padding-left: 14px;
        }

        #file-tree ul button {
            padding-left: 0px;
            display: flex;
            align-items: center;

            background: none;
            border: none;
            padding: 0;
            margin: 0;
            outline: none;
            box-shadow: none;
            font: inherit;
            color: #606060;
        }

        #file-tree ul {
            list-style-type: none;
            padding-left: 0px;
            margin-left: 0px;
        }

        #file-tree ul ul,
        #file-tree ul li.file {
            padding-left: 7px;
            padding-top: 5px;
        }

        /*First level files*/
        #file-tree>ul>li.file {
            margin-left: 14px;
        }

        /* Left border for nested child files */
        #file-tree ul ul li.file {
            border-left: 1px solid #e0e0e0;
        }

        #file-tree ul li.file {
            margin-left: 0px;
        }

        #file-tree ul li.file:hover,
        #file-tree ul li.dir button:hover {
            background-color: #e4e4e4;
        }

        #file-tree ul li,
        #file-tree ul ul li {
            padding-bottom: 4px;
        }

        .dynamic-svg {
            width: 100%;
            height: 100%;
            max-width: 16px;
            max-height: 16px;
        }
    </style>
</head>

<body>
    <div id="vault-name">{{ site.obsidian_vault | split: "/" | last }}</div>
    <div id="file-tree"></div>
</body>

<script lang="text/javascript">
    function buildFileTree(rootElement, tree) {
        const ul = document.createElement('ul');
        rootElement.appendChild(ul);

        tree.forEach(child => {
            const li = document.createElement('li');
            ul.appendChild(li);

            const button = document.createElement('button');
            const decodedString = he.decode(child.name);
            button.textContent = decodedString;
            li.appendChild(button);

            if (child.type === 'dir') {
                li.classList.add('dir');

                button.innerHTML = DOMPurify.sanitize(getSVGArrow(false) + button.textContent);

                var expanded = false;
                button.addEventListener('click', () => {
                    expanded = !expanded;
                    button.innerHTML = DOMPurify.sanitize(getSVGArrow(expanded) + button.textContent);

                    if (expanded) {
                        if (!li.querySelector('ul'))
                            buildFileTree(li, child.children);
                    } else {
                        const nestedUl = li.querySelector('ul');
                        if (nestedUl) li.removeChild(nestedUl);
                    }
                });
            } else if (child.type === 'file') {
                li.classList.add('file');
                const decodedPath = he.decode(child.path);

                button.addEventListener('click', () => {
                    var event = new CustomEvent('obisidianFileSelect', { detail: decodedPath });
                    document.dispatchEvent(event);
                });
                const fileName = child.name.replace(/\.[^/.]+$/, "")
                button.textContent = he.decode(fileName);
            }
        });
    }

    let obsidianFilesJson = '{{ site.data.obsidian_files_json | escape }}';
    var parsedObsidianFilesJson = JSON.parse(obsidianFilesJson.replace(/&quot;/g, '"'));

    function sortObsidianFiles(tree) {
        tree.sort((a, b) => {
            if (a.type === 'dir' && b.type === 'file') {
                return -1;
            } else if (a.type === 'file' && b.type === 'dir') {
                return 1;
            } else return a.name.localeCompare(b.name);
        });
        tree.forEach(child => {
            if (child.type === 'dir') {
                sortObsidianFiles(child.children);
            }
        });
        return tree;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const rootElement = document.getElementById('file-tree');
        const sortedFiles = sortObsidianFiles(parsedObsidianFilesJson);
        buildFileTree(rootElement, sortedFiles);
    });
    console.log(parsedObsidianFilesJson);
    console.log("DIR root " + '{{ site.obsidian_vault | escape }}')
</script>