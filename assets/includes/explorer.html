<body>
    <div id="vault-name">
        <div id="text">
            {{ site.obsidian_vault | split: "/" | last }}</div>
        <button id="collapseExpand"></button>
    </div>
    <div id="file-tree"></div>
</body>
<!-- ------------------------- File tree generator ------------------------- -->
<script lang="text/javascript">
    function buildFileTree(rootElement, tree, expandRoot = false) {
        const old_ul = rootElement.querySelector('ul');
        if (old_ul) rootElement.removeChild(old_ul);
        const ul = document.createElement('ul');
        rootElement.appendChild(ul);

        tree.forEach(child => {
            const li = document.createElement('li');
            ul.appendChild(li);

            const button = document.createElement('button');
            const decodedString = he.decode(child.name);
            button.textContent = decodedString;
            li.appendChild(button);

            if (child.type === 'dir') {
                li.classList.add('dir');

                button.innerHTML =
                    DOMPurify.sanitize(getSVGIcon(Icon.RightArrow) + button.textContent);
                var expanded = false;
                button.addEventListener('click', () => {
                    expanded = !expanded;
                    button.innerHTML =
                        DOMPurify.sanitize((expanded ? getSVGIcon(Icon.DownArrow)
                            : getSVGIcon(Icon.RightArrow)) + button.textContent);

                    if (expanded) {
                        if (!li.querySelector('ul'))
                            buildFileTree(li, child.children);
                    } else {
                        const nestedUl = li.querySelector('ul');
                        if (nestedUl) li.removeChild(nestedUl);
                    }
                });
                if (expandRoot === true) {
                    expanded = true;
                    button.innerHTML =
                        DOMPurify.sanitize(getSVGIcon(Icon.DownArrow) + button.textContent);
                    if (!li.querySelector('ul'))
                        buildFileTree(li, child.children, true);
                }

            } else if (child.type === 'file') {
                li.classList.add('file');
                button.addEventListener('click', () => {
                    dispatchFileSelectEvt(he.decode(child.path));
                });
                const fileName = child.name.replace(/\.[^/.]+$/, "")
                button.textContent = he.decode(fileName);
            }
        });
    }

    function sortObsidianVaultFiles(tree) {
        tree.sort((a, b) => {
            if (a.type === 'dir' && b.type === 'file') {
                return -1;
            } else if (a.type === 'file' && b.type === 'dir') {
                return 1;
            } else return a.name.localeCompare(b.name);
        });
        tree.forEach(child => {
            if (child.type === 'dir') {
                sortObsidianVaultFiles(child.children);
            }
        });
        return tree;
    }
    let expandOrCollapseFileTree = false;
    document.addEventListener('DOMContentLoaded', () => {
        buildFileTree(FILE_TREE, sortObsidianVaultFiles(VAULT_FILES));

        const collapseExpand = EXPLORER.querySelector('#vault-name #collapseExpand');
        collapseExpand.innerHTML = DOMPurify.sanitize(getSVGIcon(Icon.ChevronExpand));
        collapseExpand.addEventListener('click', () => {
            expandOrCollapseFileTree = !expandOrCollapseFileTree;
            if (expandOrCollapseFileTree)
                EXPLORER.classList.add('hide-scrollbar');
            buildFileTree(FILE_TREE, sortedVaultFiles, expandOrCollapseFileTree);
            collapseExpand.innerHTML = DOMPurify.sanitize((expandOrCollapseFileTree ?
                getSVGIcon(Icon.ChevronCollapse)
                : getSVGIcon(Icon.ChevronExpand)));
        });

        // scroll listener
        EXPLORER.addEventListener('scroll', () => {
            if (EXPLORER.scrollTop < 250) {
                EXPLORER.classList.add('hide-scrollbar');
            } else
                EXPLORER.classList.remove('hide-scrollbar');
        });
    });
</script>