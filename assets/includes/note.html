<head>
    <style>
        #obsidian #fileread #note {
            padding-top: 0;
            padding-bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        #obsidian #fileread #note-title {
            font-size: 2em;
            font-weight: bold;
            margin: .2em 0 1rem 0;
        }

        #obsidian #fileread #note .backlink {
            color: var(--color-accent);
            font-size: inherit;
        }

        /* --------------------------- Linked mentions --------------------------- */
        #obsidian #fileread #note #linked-mentions {
            font-size: 1.2em;
            width: 100%;
            margin: 8rem 0 3rem 0;
            border-top: 1px solid var(--color-border);
        }

        #obsidian #fileread #note .backlink,
        #obsidian #fileread #note #linked-mentions .title {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            cursor: pointer;
        }

        #obsidian #fileread #note #linked-mentions ul,
        #obsidian #fileread #note #linked-mentions .title {
            list-style: none;
            padding: 0;
            width: 100%;
            margin-left: 0px;
            padding-top: 4px;
            margin-bottom: 5px;
        }

        #obsidian #fileread #note #linked-mentions .title button {
            font-size: .8em;
            display: block;
            width: auto;
            text-align: left;
            padding: 5px 5px 5px 10px;
        }

        #obsidian #fileread #note #linked-mentions button:hover {
            background-color: var(--bg-linked-mention-highlight);
        }

        #obsidian #fileread #note #linked-mentions button ul li.sentence {
            color: var(--color-linked-mention-text);
            width: 96%;
            padding: 8px 5px;
            font-size: 1rem;
            line-height: 1.4rem;
        }

        #obsidian #fileread #note #linked-mentions ul button.sentence:first-child {
            border: 1px solid var(--color-border);
            border-top-left-radius: .6rem;
            border-top-right-radius: .6rem;
        }

        #obsidian #fileread #note #linked-mentions ul button.sentence:not(:first-child),
        #obsidian #fileread #note #linked-mentions ul button.sentence:last-child:hover {
            border-bottom: 1px solid var(--color-border);
            border-left: 1px solid var(--color-border);
            border-right: 1px solid var(--color-border);
        }

        #obsidian #fileread #note #linked-mentions ul button.sentence:last-child {
            border-bottom-left-radius: .6rem;
            border-bottom-right-radius: .6rem;
        }
    </style>
</head>

<!-- -------------------------------- Note --------------------------------- -->

<body>
    <h3 id="note-title"></h3>
    <div id="note-content"></div>
    <ul id="linked-mentions"></ul>
</body>

<script>
    function loadNote(filePath, header = "") {
        console.log("filePath: " + filePath);
        if (filePath.startsWith('/'))
            filePath = filePath.substring(1);
        generateBreadcrumbs(filePath);
        fetchNoteContent(filePath, header);
        FILEREAD.removeEventListener('wheel', adjustCanvasScaleOnScroll);
    }

    function fetchNoteContent(filePath, header = "") {
        const fullFilePath = getFullFilePath('/' + filePath);
        console.debug("fullNoteFilePath: " + fullFilePath)
        fetch(fullFilePath).then(response => {
            if (!response.ok)
                throw new Error('Network response: ' + response.statusText);
            return response.text();
        }).then(content => {
            NOTE.querySelector('#note-title').textContent =
                extractFilenameFromPath(filePath);

            const noteDiv =  parseStringToMarkdown(content);

            NOTE.querySelector('#note-content').innerHTML =
                DOMPurify.sanitize(noteDiv.innerHTML);
            noteDiv.remove();

            FILEREAD.scrollTop = 0;
            FILEREAD.scrollLeft = 0;
            if (header) {
                const headers = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
                headers.forEach((heading) => {
                    if (heading.textContent === header) heading.scrollIntoView();
                });
            }

            if (BACKLINKS_JSON) {
                mapBacklinksToJson(BACKLINKS_JSON);
                generateLinkedMentions(filePath, BACKLINKS_JSON);
            }
        }).catch(error => {
            console.error('Error fetching file:', error);
        });
    }
</script>

<!-- ---------------------- Generate Linked Mentions ----------------------- -->
<script>
    function generateLinkedMentions(filePath, backlinks_parsed) {
        const vaultPath = '/' + VAULTPATH + '/';
        const linkedMentionsId =
            NOTE.querySelector('#linked-mentions');
        while (linkedMentionsId.firstChild)
            linkedMentionsId.removeChild(linkedMentionsId.firstChild);
        let linked_mentions = [];
        for (const parsedFilePath in backlinks_parsed) {
            const entry = backlinks_parsed[parsedFilePath];
            entry.backlink_paths.forEach(path => {
                if (path === filePath && parsedFilePath.endsWith('.md')) {
                    console.log("linked mention: " + parsedFilePath);
                    linked_mentions.push(parsedFilePath.replace("/:|", "'"));
                }
            });
        }
        if (linked_mentions.length !== 0) {
            const h4 = document.createElement('h4');
            h4.textContent = 'Linked mentions';
            linkedMentionsId.appendChild(h4);
        }
        linked_mentions.forEach(linkedMentionPath => {
            const li = document.createElement('li');
            const linkedPathName = extractFilenameFromPath(linkedMentionPath);
            linkedMentionsId.appendChild(li);
            li.classList.add('title');
            const decodedString = he.decode(linkedPathName);
            li.textContent = decodedString;

            const linkedMentionPathFull = vaultPath + linkedMentionPath;
            fetch(linkedMentionPathFull)
                .then(response => {
                    if (!response.ok)
                        throw new Error('Network response: ' + response.statusText);
                    return response.text();
                }).then(content => {
                    const ul_linkedMention = document.createElement('ul');
                    li.appendChild(ul_linkedMention);
                    const backlink = `[[${extractFilenameFromPath(filePath)}]]`;
                    let lines = content.split('\n');
                    lines.forEach(line => {
                        if (line) {
                            const line_backlinks = extractBacklinks(line);
                            if (line_backlinks) {
                                line_backlinks.forEach(line_backlink => {
                                    const stripped_backlink =
                                        line_backlink.toLowerCase().replace(/\|.*?\]\]/, ']]').replace(/#.*?\]\]/, ']]');
                                    if (stripped_backlink === backlink.toLowerCase()) {
                                        const btnLinkedMention = document.createElement('button');
                                        btnLinkedMention.textContent = line;
                                        btnLinkedMention.classList.add('sentence');
                                        btnLinkedMention.dataset.filePath = linkedMentionPathFull;

                                        btnLinkedMention.addEventListener('click', function () {
                                            const filePath = this.dataset.filePath.replace(vaultPath, '');
                                            console.info("linked mention clicked: " + filePath);
                                            dispatchFileSelectEvt(filePath);
                                        });
                                        ul_linkedMention.appendChild(btnLinkedMention);
                                    }
                                });
                            }
                        }
                    });
                }).catch(error => {
                    console.error('Error fetching file:', error);
                });
        });
    }
</script>

<!-- ------------------------ Note event listeners ------------------------- -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const homepage = '{{ site.obsidian_homepage | escape }}'
        if (homepage && homepage.endsWith('.md')) {
            switchPage(homepage);
            loadNote(homepage);
            console.log("note loaded: " + homepage);
        }
    });

    document.addEventListener('obsidian_noteSelect', function (event) {
        switchPage(event.detail.filePath);
        loadNote(event.detail.filePath, event.detail.heading);
    });
</script>